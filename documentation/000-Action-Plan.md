# Action Plan for SmartSource RAG Agent

This document provides detailed technical guidance for developing the SmartSource RAG Agent application code.

## Technical Architecture

The SmartSource RAG Agent implements a modular architecture with the following components:

### Agent Framework Integration

- **LangGraph**

- **LangSmith Tracing**: Full observability infrastructure

### Agent Implementations

- **SmartSource RAG Agent** (`smartsource_agent.py`)

  - RAG implementation with multi-index search
  - Document formatting and source attribution
  - Conversation history management
  - Vector and hybrid search with RRF ranking

- **OpenAI Agents** (`openai_agent.py`)

  - Direct Azure OpenAI model access
  - GPT-4o and GPT-4o-mini model support
  - GPT-4.1, GPT-4.1-mini, and GPT-4.1-nano model support
  - Tool augmentation
  - System prompt configuration

- **Agent Registry** (`registry.py`)
  - Centralized agent management
  - Dynamic agent selection by name
  - Consistent agent configuration

### Asynchronous API Implementation

- **FastAPI Integration** (`routes.py`)
  - Unified endpoint for all agents
  - SSE streaming with standardized format
  - Request validation
  - Error handling
  - Health check endpoints
  - Performance monitoring with LangSmith

### Retrieval System

- **Elasticsearch Integration** (`retriever.py`)

  - Multi-index parallel search
  - Vector (KNN) similarity search
  - Keyword (BM25) matching
  - Reciprocal Rank Fusion algorithm
  - Source tracking
  - Function span performance monitoring

- **Document Processing** (`document_processor.py`)
  - Document standardization
  - Source attribution formatting
  - Metadata extraction
  - Result combination and ranking

### Azure OpenAI Integration

- **Client Management** (`llm_clients.py`)
  - Azure OpenAI client configuration
  - Model deployment selection
  - API version management
  - Embedding model configuration

### Function Tools

- **Search Tool** (`search_tool.py`)

  - Multi-index Elasticsearch search
  - Query vectorization
  - RRF result ranking
  - Query refinement support
  - Performance tracing

- **Date Tool** (`date_tool.py`)

  - Current date/time information
  - Timezone handling
  - Formatted date output

- **Web Scraping Tool** (`webscraper_tool.py`)
  - URL content extraction
  - HTML processing and cleaning
  - Metadata retrieval
  - Error handling

### Streaming Infrastructure

- **Agent Streaming** (`agent_streaming.py`)
  - Standardized streaming interface
  - SSE event formatting
  - Plain text mode
  - Connection management
  - Error handling
  - Trace context management
  - UUID-based chat tracing grouping

## Code Architecture Details

### Agent Initialization Flow

1. Environment variables loaded from `.env` via `settings.py`
2. Azure OpenAI client created in `llm_clients.py`
3. Client configured as default for Agents SDK
4. LangSmith tracing processor registered
5. Agent registry populated with agent implementations
6. FastAPI router configured with agent endpoints

### RAG Query Execution Flow

1. User query received via API endpoint
2. Query vectorized using Azure OpenAI embeddings
3. Parallel search executed across multiple indices
4. Results ranked using RRF algorithm
5. Documents processed and formatted with sources
6. Response generated by SmartSource agent with citations
7. Response streamed via SSE to client

### Observability with LangSmith

1. Trace context created for each API request
2. Function spans recorded for key operations
3. Document retrieval metrics captured
4. Token usage measured for API calls
5. Latency metrics recorded for all operations
6. Error information preserved with context
